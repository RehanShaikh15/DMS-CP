{% extends "base.html" %}
{% block content %}

<h3 class="mb-4">Weekly Timetable</h3>

<!-- âž• ADD SLOT FORM -->
<div class="card mb-4">
    <div class="card-body">
        <form method="post">
    {{ form.hidden_tag() }}

    <div class="mb-3">
        {{ form.department_id.label }}
        {{ form.department_id(class="form-select", id="department") }}
    </div>

    <div class="mb-3">
        {{ form.faculty_id.label }}
        {{ form.faculty_id(class="form-select", id="faculty") }}
    </div>

    <div class="mb-3">
        {{ form.subject_id.label }}
        {{ form.subject_id(class="form-select", id="subject") }}
    </div>

    <div class="mb-3">
        {{ form.academic_class_id.label }}
        {{ form.academic_class_id(class="form-select", id="academic_class") }}
    </div>
            <div class="col-md-4">
    {{ form.classroom_id.label }}
    {{ form.classroom_id(class="form-select") }}
</div>

     <div class="mb-3">
    {{ form.start_time.label }}
    {{ form.start_time(class="form-select") }}
</div>


    <div class="mb-3 mt-2">
        {{ form.day.label }}
        {{ form.day(class="form-select") }}
    </div>

    {{ form.submit(class="btn btn-primary") }}
</form>
    </div>
</div>

<!-- ðŸ“… WEEKLY GRID -->
<div class="table-responsive">
<table class="table table-bordered text-center">
    <thead>
        <tr>
            <th>Time</th>
            {% for day in days %}
                <th>{{ day }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for time in times %}
        <tr>
            <th>{{ time }}</th>
            {% for day in days %}
                <td>
                    {% if grid[day][time] %}
                        <strong>{{ grid[day][time].subject.subject_name }}</strong><br>
                        {{ grid[day][time].faculty.name }}<br>
                        {{ grid[day][time].academic_class.name }}
                        <small>{{ grid[day][time].classroom.room_code }}</small>
                    {% else %}
                        â€”
                    {% endif %}
                </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

</div>
<script>
const dept = document.getElementById("department");
const faculty = document.getElementById("faculty");
const subject = document.getElementById("subject");
const cls = document.getElementById("academic_class");

function loadDepartmentData(deptId) {
    faculty.innerHTML = "<option value=''>Select Faculty</option>";
    subject.innerHTML = "<option value=''>Select Subject</option>";
    cls.innerHTML = "<option value=''>Select Class</option>";

    if (!deptId) return;

    fetch(`/api/department/${deptId}/data`)
        .then(res => res.json())
        .then(data => {
            data.faculty.forEach(f => {
                faculty.innerHTML += `<option value="${f.id}">${f.name}</option>`;
            });

            data.subjects.forEach(s => {
                subject.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });

            data.classes.forEach(c => {
                cls.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        })
        .catch(err => console.error("API error:", err));
}

// ðŸ”¹ On change
dept.addEventListener("change", function () {
    loadDepartmentData(this.value);
});

// ðŸ”¹ ON PAGE LOAD (THIS WAS MISSING)
document.addEventListener("DOMContentLoaded", function () {
    if (dept.value) {
        loadDepartmentData(dept.value);
    }
});
</script>




{% endblock %}
