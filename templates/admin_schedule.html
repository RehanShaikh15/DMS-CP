{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2 class="mb-4">Schedule Center</h2>

        <!-- TABS NAV -->
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'manage' %}active{% endif %}" id="pills-manage-tab"
                    data-bs-toggle="pill" data-bs-target="#pills-manage" type="button" role="tab">Timetable
                    Editor</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'classroom' %}active{% endif %}" id="pills-room-tab"
                    data-bs-toggle="pill" data-bs-target="#pills-room" type="button" role="tab">Classroom
                    Viewer</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'daily' %}active{% endif %}" id="pills-daily-tab"
                    data-bs-toggle="pill" data-bs-target="#pills-daily" type="button" role="tab">Daily Monitor</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">

            {# ================= TAB 1: MANAGE (Editor) ================= #}
            <div class="tab-pane fade {% if active_tab == 'manage' %}show active{% endif %}" id="pills-manage"
                role="tabpanel">
                <div class="card shadow mb-4">
                    <div class="card-body">
                        <h5 class="mb-3">Add Class Slot</h5>
                        <form method="post" action="{{ url_for('admin_schedule', tab='manage') }}">
                            {{ manage_form.hidden_tag() }}
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    {{ manage_form.department_id.label(class="form-label") }}
                                    {{ manage_form.department_id(class="form-select", id="department") }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    {{ manage_form.faculty_id.label(class="form-label") }}
                                    {{ manage_form.faculty_id(class="form-select", id="faculty") }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    {{ manage_form.subject_id.label(class="form-label") }}
                                    {{ manage_form.subject_id(class="form-select", id="subject") }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    {{ manage_form.academic_class_id.label(class="form-label") }}
                                    {{ manage_form.academic_class_id(class="form-select", id="academic_class") }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    {{ manage_form.classroom_id.label(class="form-label") }}
                                    {{ manage_form.classroom_id(class="form-select") }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    {{ manage_form.day.label(class="form-label") }}
                                    {{ manage_form.day(class="form-select") }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    {{ manage_form.start_time.label(class="form-label") }}
                                    {{ manage_form.start_time(class="form-select") }}
                                </div>
                                <div class="col-md-3 mb-3 d-grid align-items-end">
                                    {{ manage_form.submit(class="btn btn-primary") }}
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- WEEKLY GRID -->
                <div class="card shadow">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Time</th>
                                        {% for day in days %}
                                        <th>{{ day }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for time in times %}
                                    <tr>
                                        <th class="align-middle bg-light">{{ time }}</th>
                                        {% for day in days %}
                                        <td class="align-middle">
                                            {% if manage_grid[day][time] %}
                                            <div class="p-1">
                                                <strong>{{ manage_grid[day][time].subject.subject_name }}</strong><br>
                                                <span class="text-muted small">{{ manage_grid[day][time].faculty.name
                                                    }}</span><br>
                                                <span class="badge bg-secondary">{{
                                                    manage_grid[day][time].academic_class.name }}</span>
                                                <span class="badge bg-info text-dark">{{
                                                    manage_grid[day][time].classroom.room_code }}</span>
                                            </div>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            {# ================= TAB 2: CLASSROOM VIEWER ================= #}
            <div class="tab-pane fade {% if active_tab == 'classroom' %}show active{% endif %}" id="pills-room"
                role="tabpanel">
                <div class="card shadow mb-4">
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('admin_schedule', tab='classroom') }}"
                            class="row align-items-end">
                            {{ classroom_form.hidden_tag() }}
                            <div class="col-md-4">
                                {{ classroom_form.classroom_id.label(class="form-label") }}
                                {{ classroom_form.classroom_id(class="form-select") }}
                            </div>
                            <div class="col-md-2">
                                {{ classroom_form.submit(class="btn btn-primary w-100") }}
                            </div>
                        </form>
                    </div>
                </div>

                {% if selected_classroom %}
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">Schedule: <span class="text-primary">{{ selected_classroom.room_code }}</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped text-center mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Time</th>
                                        {% for day in days %}
                                        <th>{{ day }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for time in times %}
                                    <tr>
                                        <th class="align-middle bg-light">{{ time }}</th>
                                        {% for day in days %}
                                        <td class="align-middle">
                                            {% if classroom_grid[day][time] %}
                                            {% set slot = classroom_grid[day][time] %}
                                            <div class="p-2 bg-success-subtle border-success rounded">
                                                <div class="fw-bold text-dark small">{{ slot.subject.subject_name }}
                                                </div>
                                                <div class="text-secondary x-small">{{ slot.faculty.name }}</div>
                                                <div class="badge bg-secondary mt-1">{{ slot.academic_class.name }}
                                                </div>
                                            </div>
                                            {% else %}
                                            <span class="text-muted small">-</span>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            {# ================= TAB 3: DAILY MONITOR ================= #}
            <div class="tab-pane fade {% if active_tab == 'daily' %}show active{% endif %}" id="pills-daily"
                role="tabpanel">
                <div class="card shadow mb-4">
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('admin_schedule', tab='daily') }}"
                            class="row align-items-end justify-content-center">
                            {{ daily_form.hidden_tag() }}
                            <div class="col-md-4">
                                {{ daily_form.date.label(class="form-label") }}
                                {{ daily_form.date(class="form-control") }}
                            </div>
                            <div class="col-md-2">
                                {{ daily_form.submit(class="btn btn-primary w-100") }}
                            </div>
                        </form>
                    </div>
                </div>

                {% if daily_schedule_data %}
                <div class="card shadow">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Daily Schedule: <span class="text-info">{{ day_name }}</span> ({{ selected_date
                            }})</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 15%">Time</th>
                                        <th>Classroom</th>
                                        <th>Subject</th>
                                        <th>Faculty</th>
                                        <th>Class</th>
                                        <th style="width: 15%">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in daily_schedule_data %}
                                    <tr class="{% if item.is_blocked %}table-danger{% endif %}">
                                        <td class="align-middle fw-bold">
                                            {{ item.slot.start_time.strftime('%H:%M') }} - {{
                                            item.slot.end_time.strftime('%H:%M') }}
                                        </td>
                                        <td class="align-middle">
                                            <span class="badge bg-secondary">{{ item.slot.classroom.room_code }}</span>
                                        </td>
                                        <td class="align-middle">
                                            {{ item.slot.subject.subject_name }}
                                        </td>
                                        <td class="align-middle">
                                            {{ item.slot.faculty.name }}
                                        </td>
                                        <td class="align-middle">
                                            {{ item.slot.academic_class.name }}
                                        </td>
                                        <td class="align-middle text-center">
                                            {% if item.is_blocked %}
                                            <span class="badge bg-danger rounded-pill px-3 py-2">
                                                <i class="bi bi-x-circle-fill me-1"></i> ON LEAVE
                                            </span>
                                            {% else %}
                                            <span class="badge bg-success rounded-pill px-3">Active</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<script>
    // JS for dynamic dropdowns in Manage Tab
    const dept = document.getElementById("department");
    const faculty = document.getElementById("faculty");
    const subject = document.getElementById("subject");
    const cls = document.getElementById("academic_class");

    function loadDepartmentData(deptId) {
        faculty.innerHTML = "<option value=''>Select Faculty</option>";
        subject.innerHTML = "<option value=''>Select Subject</option>";
        cls.innerHTML = "<option value=''>Select Class</option>";

        if (!deptId) return;

        fetch(`/api/department/${deptId}/data`)
            .then(res => res.json())
            .then(data => {
                data.faculty.forEach(f => {
                    faculty.innerHTML += `<option value="${f.id}">${f.name}</option>`;
                });
                data.subjects.forEach(s => {
                    subject.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
                data.classes.forEach(c => {
                    cls.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                });
            })
            .catch(err => console.error("API error:", err));
    }

    if (dept) {
        dept.addEventListener("change", function () {
            loadDepartmentData(this.value);
        });
    }
</script>
{% endblock %}